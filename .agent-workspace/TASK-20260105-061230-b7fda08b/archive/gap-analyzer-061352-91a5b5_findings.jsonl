{"timestamp": "2026-01-05T06:16:18.323093", "agent_id": "gap-analyzer-061352-91a5b5", "finding_type": "insight", "severity": "high", "message": "Gap analysis complete - identified 1 MISSING state_db function needed for full migration", "data": {"missing_functions": [{"function_name": "get_agent_by_id", "signature": "get_agent_by_id(*, workspace_base: str, task_id: str, agent_id: str) -> Optional[Dict[str, Any]]", "purpose": "Get a single agent by ID with all fields including tracked_files JSON", "used_by": ["agents.py:136 (_resolve_tracked_file)", "agents.py:270 (get_agent endpoint)"], "implementation_notes": "Simple SELECT * FROM agents WHERE task_id=? AND agent_id=? query. Must parse tracked_files JSON field before returning.", "priority": "HIGH"}], "existing_functions_can_reuse": [{"function_name": "get_agents_for_task", "location": "state_db.py:1748", "can_replace": "agents.py:230 (list_agents endpoint)", "usage": "state_db.get_agents_for_task(workspace_base=workspace, task_id=task_id)"}, {"function_name": "load_task_snapshot", "location": "state_db.py:925", "can_replace": "phases.py:48,64 (get_phases endpoint)", "usage": "task_snapshot = state_db.load_task_snapshot(workspace_base=workspace, task_id=task_id); phases = task_snapshot.get('phases', []) if task_snapshot else []"}, {"function_name": "get_phase_agent_counts", "location": "state_db.py:1444", "can_replace": "phases.py:64 (get_current_phase agent counting)", "usage": "phase_counts = state_db.get_phase_agent_counts(workspace_base=workspace, task_id=task_id, phase_index=current_index)"}], "migration_summary": {"agents_py_reads_to_replace": 3, "agents_py_missing_functions": 1, "agents_py_existing_functions": 1, "phases_py_reads_to_replace": 2, "phases_py_missing_functions": 0, "phases_py_existing_functions": 2, "total_new_functions_needed": 1}, "recommended_implementation": {"function": "get_agent_by_id", "code_template": "def get_agent_by_id(*, workspace_base: str, task_id: str, agent_id: str) -> Optional[Dict[str, Any]]:\n    db_path = ensure_db(workspace_base)\n    conn = _connect(db_path)\n    try:\n        row = conn.execute(\n            'SELECT * FROM agents WHERE task_id=? AND agent_id=?',\n            (task_id, agent_id)\n        ).fetchone()\n        if not row:\n            return None\n        agent = dict(row)\n        # Parse tracked_files JSON field\n        if agent.get('tracked_files'):\n            try:\n                agent['tracked_files'] = json.loads(agent['tracked_files'])\n            except Exception:\n                agent['tracked_files'] = {}\n        return agent\n    finally:\n        conn.close()", "location_to_add": "After get_agents_for_task at line 1759 in state_db.py"}}}
