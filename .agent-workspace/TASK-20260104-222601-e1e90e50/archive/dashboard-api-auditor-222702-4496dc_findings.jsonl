{"timestamp": "2026-01-04T22:28:24.578156", "agent_id": "dashboard-api-auditor-222702-4496dc", "finding_type": "insight", "severity": "critical", "message": "Dashboard API completely depends on JSON files - NO SQLite integration exists", "data": {"current_state": "Dashboard reads from JSON files exclusively", "json_dependencies": ["GLOBAL_REGISTRY.json for task listings", "AGENT_REGISTRY.json for task details", "progress/*_progress.jsonl for agent status", "findings/*_findings.jsonl for agent findings", "logs/*_stream.jsonl for agent logs"], "critical_issue": "Tasks with active_agents > 0 never transition to COMPLETED because counts are stale in JSON", "sqlite_status": "state_db.py exists but dashboard doesn't use it"}}
{"timestamp": "2026-01-04T22:28:58.026284", "agent_id": "dashboard-api-auditor-222702-4496dc", "finding_type": "solution", "severity": "high", "message": "Endpoint-by-endpoint migration plan from JSON to SQLite", "data": {"tasks_api_endpoints": {"GET /api/tasks": {"current": "Reads from GLOBAL_REGISTRY.json and AGENT_REGISTRY.json files", "files_accessed": ["~/.agent-workspace/registry/GLOBAL_REGISTRY.json", "TASK-*/AGENT_REGISTRY.json", "progress/*_progress.jsonl"], "migration": "Query tasks table, JOIN with agents for counts", "sql_needed": "SELECT with agent status aggregation"}, "GET /api/tasks/{task_id}": {"current": "Reads AGENT_REGISTRY.json, reconciles with progress JSONL", "files_accessed": ["TASK-*/AGENT_REGISTRY.json", "progress/*_progress.jsonl"], "migration": "load_task_snapshot() from state_db", "sql_needed": "Already exists in state_db.py"}}, "agents_api_endpoints": {"GET /api/agents/{task_id}": {"current": "Reads AGENT_REGISTRY.json, merges with progress JSONL", "migration": "Query agents table WHERE task_id=?", "sql_needed": "SELECT * FROM agents WHERE task_id=?"}, "GET /api/agents/{task_id}/{agent_id}/progress": {"current": "Reads progress/*_progress.jsonl files", "migration": "Query agent_progress_latest table", "sql_needed": "SELECT * FROM agent_progress_latest WHERE agent_id=?"}, "GET /api/agents/{task_id}/{agent_id}/findings": {"current": "Reads findings/*_findings.jsonl files", "migration": "Need new findings table in SQLite", "sql_needed": "CREATE TABLE agent_findings (id, timestamp, type, severity, message)"}}, "critical_calculations": {"active_agents_count": {"current": "Loops through agents array, checks status in ['running','working','blocked']", "location": "tasks.py:446-465", "issue": "Never decrements when agents complete", "migration": "SELECT COUNT(*) FROM agents WHERE task_id=? AND status IN (active_statuses)"}, "task_status": {"current": "Read from registry JSON, stuck at INITIALIZED", "issue": "Never transitions to ACTIVE/COMPLETED", "migration": "Derive from phase status + agent counts"}, "progress_calculation": {"current": "Average of all agent progress values", "location": "tasks.py:472-473", "migration": "AVG(progress) FROM agents WHERE task_id=?"}}, "missing_tables": ["agent_findings - for storing findings", "agent_logs - for log entries (optional, JSONL may stay)", "reviews - for phase review data"], "performance_impact": "SQLite will be 10-100x faster for counts/aggregations vs JSON file parsing"}}
{"timestamp": "2026-01-04T22:29:19.462410", "agent_id": "dashboard-api-auditor-222702-4496dc", "finding_type": "recommendation", "severity": "high", "message": "Data transformation requirements between SQLite schema and API response models", "data": {"schema_mapping": {"SQLite tasks table": {"fields": ["task_id", "workspace", "description", "status", "priority", "created_at", "updated_at", "current_phase_index"], "maps_to": "TaskSummary and TaskDetail models"}, "SQLite agents table": {"fields": ["agent_id", "task_id", "type", "status", "progress", "started_at", "completed_at", "last_update"], "maps_to": "AgentData model"}, "SQLite agent_progress_latest": {"fields": ["task_id", "agent_id", "timestamp", "status", "progress", "message"], "maps_to": "AgentProgress model"}}, "transformation_functions_needed": {"normalize_datetime": "SQLite stores ISO strings, API expects datetime objects", "compute_active_count": "COUNT(*) WHERE status IN ('running','working','blocked','reviewing')", "compute_task_status": "Derive from phase status + agent counts (INITIALIZED->ACTIVE when agents>0, ->COMPLETED when all done)", "aggregate_phase_data": "JOIN phases table with agent counts per phase"}, "caching_strategy": {"recommendation": "Cache task summaries for 5-10 seconds", "reason": "Task list endpoint is called frequently", "invalidation": "On any agent progress update"}, "migration_priority": {"1_critical": ["GET /api/tasks - fix stale counts", "GET /api/tasks/{task_id} - use real-time data"], "2_high": ["Agent status endpoints - use SQLite", "Progress endpoints - query agent_progress_latest"], "3_medium": ["Findings endpoints - create findings table", "Logs endpoints - consider keeping JSONL for now"]}, "backward_compatibility": {"keep_json_writes": "Continue writing to JSON files for now", "dual_read": "Read from SQLite, fallback to JSON if DB empty", "migration_flag": "Add USE_SQLITE_STATE env var for gradual rollout"}}}
{"timestamp": "2026-01-04T22:29:43.955176", "agent_id": "dashboard-api-auditor-222702-4496dc", "finding_type": "blocker", "severity": "critical", "message": "Root cause: Dashboard reads stale JSON while MCP writes to SQLite - systems are disconnected", "data": {"problem_summary": "Dashboard and MCP operate on different data stores", "dashboard_reads": ["GLOBAL_REGISTRY.json", "AGENT_REGISTRY.json", "progress/*.jsonl files"], "mcp_writes_to": ["SQLite state.sqlite3 via state_db.py", "Also updates JSON but with race conditions"], "consequences": ["Dashboard shows stale active_agents count (97 when should be 0)", "Tasks stuck at INITIALIZED status", "Progress never updates correctly", "Dashboard shows 7 active tasks when there are none"], "files_using_registry_lock": ["health_daemon.py - writes to SQLite AND JSON", "lifecycle.py - manages phase transitions", "registry.py - defines LockedRegistryFile", "review.py - handles review verdicts", "handover.py - phase handover logic"], "integration_points": {"real_mcp_server.py": "Uses state_db for some operations", "dashboard/backend/api/routes/tasks.py": "ONLY reads JSON, no SQLite imports"}, "fix_required": "Dashboard API must import and use state_db.py functions instead of JSON reads"}}
